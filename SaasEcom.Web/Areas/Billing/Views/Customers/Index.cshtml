@{
    ViewBag.Title = "Customers";
    Layout = "~/Areas/Billing/Views/Shared/_BillingLayout.cshtml";
}

<div class="row">
    <div class="col-md-12">
        <h1 class="title"><i class="fa fa-users"></i> Customers</h1>

        @if (false && !ViewBag.AnyCustomers)
        {
            <div class="no-customers jumbotron">
                <h2>No customers yet</h2>
                <p>There are no customers to show here.</p>
            </div>
        }
        else
        {
            <div ng-app="customersApp" ng-controller="customersController" class="customers-container">
                <table ng-table="customersTable" data-template-pagination="custom-pager" data-show-filter="true" class="table">
                    <tr ng-repeat="user in $data" data-ng-click="open('lg', user)">
                        <td data-title="'Email'" data-sortable="'Email'" filter="{ 'Email': 'text' }"><i class="fa fa-user"></i> {{ user.Email }}</td>
                        <td data-title="'Plan'" data-sortable="'SubscriptionPlan'" filter="{ 'SubscriptionPlan': 'text' }">{{ user.SubscriptionPlan }} {{ user.SubscriptionPlanPrice | currency : "£" }}</td>
                        <td data-title="'Total Revenue'" data-sortable="'totalRevenue'">{{ user.TotalRevenue }}</td>
                    </tr>
                </table>
                
                <script type="text/ng-template" id="custom-pager">
                    <ul class="pager ng-cloak">
                        <li ng-repeat="page in pages"
                            ng-class="{'disabled': !page.active, 'previous': page.type == 'prev', 'next': page.type == 'next'}"
                            ng-show="page.type == 'prev' || page.type == 'next'" ng-switch="page.type">
                            <a ng-switch-when="prev" ng-click="params.page(page.number)" href="">&laquo; Previous</a>
                            <a ng-switch-when="next" ng-click="params.page(page.number)" href="">Next &raquo;</a>
                        </li>
                    </ul>
                </script>
                
                <script type="text/ng-template" id="myModalContent.html">
                    <div class="modal-header">
                        <h3 class="modal-title"><i class="fa fa-user"></i> <a href="mailto:{{ customer.Email }}">{{ customer.Email }}</a></h3>
                    </div>
                    <div class="modal-body">
                        <ul>
                            <li>{{ customer.SubscriptionPlan }}</li>
                            <li>{{ customer.TotalRevenue }}</li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" ng-click="close()">Close</button>
                    </div>
                </script>
            </div>
        }
    </div>
</div>

@section scripts{
    @Scripts.Render("~/bundles/angularjs")
    @Scripts.Render("~/bundles/angular-ng-table")
    @Scripts.Render("~/bundles/angular-ui-bootstrap")

    <script language="javascript">
        var customersModule = angular.module('customersApp', ['ngTable', 'ui.bootstrap']);

        customersModule.controller('customersController', function($http, $scope, $filter, $modal, ngTableParams) {

            $http.post('/Billing/Customers/GetCustomers').then(function(res) {
                var customers = res.data;
    
                $scope.customersTable = new ngTableParams({
                    page: 1, // show first page
                    count: 10, // count per page
                    filter: {},
                    sorting: {
                        name: 'asc' // initial sorting
                    },
                    filterDelay: 200
                }, {
                    total: customers.length, // length of data
                    getData: function ($defer, params) {
                        // use build-in angular filter
                        var filteredData = params.filter() ?
                            $filter('filter')(customers, params.filter()) : customers;
                        var orderedData = params.sorting() ?
                            $filter('orderBy')(filteredData, params.orderBy()) : customers;

                        params.total(orderedData.length); // set total for recalc pagination
                        $defer.resolve(orderedData.slice((params.page() - 1) * params.count(), params.page() * params.count()));
                    }
                });
            });

            $scope.open = function(size, $customer) {
                var modalInstance = $modal.open({
                    templateUrl: 'myModalContent.html',
                    controller: 'ModalInstanceCtrl',
                    size: size,
                    resolve: { customer: function() {
                        return angular.copy($customer);
                    }}
                });
            };
        });

        customersModule.controller('ModalInstanceCtrl', function ($scope, $modalInstance, customer) {
            $scope.customer = customer;

            $scope.close = function () {
                $modalInstance.dismiss();
            };

            this.$inject = ["$scope", "$modalInstance", "customer"];
        });
    </script>
}
